<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QRコードリーダー</title>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      font-family: Arial, sans-serif;
    }
    #startScreen {
      text-align: center;
    }
    button {
      margin-top: 20px;
      padding: 10px 20px;
      font-size: 18px;
      cursor: pointer;
    }
    video {
      border: 1px solid black;
    }
  </style>
</head>
<body>
  <div id="startScreen">
    <h1>QRコードリーダー</h1>
    <button id="startButton">QRコードを読み取る</button>
  </div>

  <div id="scanner" style="display: none;">
    <h2>QRコードをかざしてください</h2>
    <video id="preview" width="100%" height="100%" playsinline></video>
    <p id="scanResult">結果がここに表示されます</p>
    <button id="backToStartButton">戻る</button>
  </div>

  <script src="https://unpkg.com/jsqr/dist/jsQR.js"></script>
  <script>
    const startButton = document.getElementById("startButton");
    const backToStartButton = document.getElementById("backToStartButton");
    const startScreen = document.getElementById("startScreen");
    const scanner = document.getElementById("scanner");
    const video = document.getElementById("preview");
    const scanResult = document.getElementById("scanResult");

    let canvasElement = document.createElement("canvas");
    let canvas = canvasElement.getContext("2d");

    startButton.addEventListener("click", () => {
      startScreen.style.display = "none";
      scanner.style.display = "block";

      navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
        .then((stream) => {
          video.srcObject = stream;
          video.setAttribute("playsinline", true);
          video.play();
          requestAnimationFrame(scanQRCode);
        })
        .catch((error) => {
          console.error("カメラの起動に失敗しました:", error);
          alert("カメラが利用できません。");
        });
    });

    function scanQRCode() {
      if (video.readyState === video.HAVE_ENOUGH_DATA) {
        canvasElement.height = video.videoHeight;
        canvasElement.width = video.videoWidth;
        canvas.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);
        let imageData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height);
        let code = jsQR(imageData.data, canvasElement.width, canvasElement.height);

        if (code) {
          const qrData = code.data;
          const [id, name] = qrData.split(",");
          const timestamp = new Date().toLocaleString();

          if (id && name) {
            scanResult.textContent = `ID: ${id}, 名前: ${name}, 時間: ${timestamp}`;
            
            // Googleスプレッドシートにデータを送信
            sendDataToGoogleSheets(id, name, timestamp);

            // ビデオストリームを停止
            if (video.srcObject) {
              video.srcObject.getTracks().forEach(track => track.stop());
            }
          } else {
            alert("QRコードの形式が正しくありません！");
          }
        }
      }
      requestAnimationFrame(scanQRCode);
    }

    backToStartButton.addEventListener("click", () => {
      scanner.style.display = "none";
      startScreen.style.display = "block";
      scanResult.textContent = "結果がここに表示されます";

      if (video.srcObject) {
        video.srcObject.getTracks().forEach(track => track.stop());
      }
    });

    function sendDataToGoogleSheets(id, name, timestamp) {
      const scriptUrl = "https://script.google.com/macros/s/AKfycbzt_Dkl6DBD32aqbJZkuhmdqPTe8eKBJkubYi2KHDvSfiBXnHNbJM8DV7OrTgiapN7T/exec";
      const url = `${scriptUrl}?id=${encodeURIComponent(id)}&name=${encodeURIComponent(name)}&timestamp=${encodeURIComponent(timestamp)}`;
      
      console.log("リクエストURL:", url);  // リクエストURLを確認
      
      fetch(url)
        .then(response => response.text())
        .then(data => {
          console.log("サーバーからの応答:", data);  // 応答確認
        })
        .catch(error => {
          console.error("エラーが発生しました:", error);
        });
    }
  </script>
</body>
</html>
